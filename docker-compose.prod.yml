services:
  db:
    extends:
      file: docker-compose.yml
      service: db

  backend:
    extends:
      file: docker-compose.yml
      service: backend
    ports: []

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: app-frontend
    depends_on:
      backend:
        condition: service_started
    expose:
      - "3000"
    ports: []
    restart: unless-stopped

  reverse-proxy:
    image: caddy:2.8
    container_name: app-proxy
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
      frontend:
        condition: service_started
    environment:
      CADDY_PRIMARY_DOMAIN: ${CADDY_PRIMARY_DOMAIN:?CADDY_PRIMARY_DOMAIN is required in production}
      CADDY_API_DOMAIN: ${CADDY_API_DOMAIN:?CADDY_API_DOMAIN is required in production}
      CADDY_ACME_EMAIL: ${CADDY_ACME_EMAIL:?CADDY_ACME_EMAIL is required in production}
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"

volumes:
  caddy_data:
  caddy_config:
  mysql_data:
    name: app-mysql-data
